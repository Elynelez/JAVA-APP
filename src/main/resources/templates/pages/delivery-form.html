<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Formulario | Mensajería Rápida</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body class="bg-light">

    <!-- HEADER -->
    <div th:insert="fragments/layout :: header"></div>

    <!-- FORMULARIO -->
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body p-5">
                    <h3 class="text-center mb-4 text-primary">
                        <i class="bi bi-truck"></i> Crear Ruta de Entrega
                    </h3>
                    <form id="deliveryForm" th:action="@{/delivery/travel}" method="post">

                        <!-- Mensajero -->
                        <div class="mb-3">
                            <label for="coursier" class="form-label">Mensajero</label>
                            <select name="coursier" id="coursier" class="form-select" required>
                                <option th:each="c : ${coursiers}" th:value="${c.id}" th:text="${c.name}"></option>
                            </select>
                        </div>

                        <!-- Agregar Pedido -->
                        <div class="mb-3">
                            <label for="itemInput" class="form-label">Agregar Pedido</label>
                            <div class="input-group">
                                <input type="text" id="itemInput" class="form-control" placeholder="Ej: PED1234" />
                                <button type="button" onclick="addItem()" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-circle"></i> Agregar
                                </button>
                            </div>
                        </div>

                        <!-- Pedidos Agregados -->
                        <div class="mb-3">
                            <label class="form-label">Pedidos Agregados</label>
                            <div style="max-height: 200px; overflow-y: auto;">
                                <ul id="ordersList" class="list-group">
                                    <!-- JS Insertará aquí los pedidos -->
                                </ul>
                            </div>
                        </div>

                        <!-- Botón enviar -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-send-check"></i> Enviar Pedidos
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div th:insert="fragments/layout :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let items = JSON.parse(localStorage.getItem("items")) || [];
        const input = document.getElementById("itemInput");
        const ordersSelect = document.getElementById("orders");

        function updateSelect() {
            const ordersList = document.getElementById("ordersList");
            ordersList.innerHTML = '';

            items.forEach((item, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";

                li.innerHTML = `
            ${item}
            <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${index})">
                <i class="bi bi-x-lg"></i>
            </button>
        `;
                ordersList.appendChild(li);
            });

            // También actualiza los inputs ocultos para el form
            document.querySelectorAll("input[name='orders']").forEach(el => el.remove());
            const form = document.getElementById("deliveryForm");
            items.forEach(value => {
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "orders";
                hiddenInput.value = value;
                form.appendChild(hiddenInput);
            });
        }

        function removeItem(index) {
            items.splice(index, 1);
            localStorage.setItem("items", JSON.stringify(items));
            updateSelect();
        }

        function addItem() {
            const code = input.value.toUpperCase().trim();
            if (!code) return alert("No puedes enviar contenido vacío");
            if (items.includes(code) || items.includes(code + "**")) {
                return alert("No puedes repetir pedidos");
            }

            fetch(`/api/check-client/${code}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.exists) {
                        alert(data.message || "Cliente inválido");
                        return;
                    }
                    // Si pasa la validación, agregar a la lista
                    items.push(code);
                    localStorage.setItem("items", JSON.stringify(items));
                    updateSelect();
                    input.value = '';
                })
                .catch(err => {
                    console.error(err);
                    alert("Error validando cliente");
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            updateSelect();
        });

    </script>
</body>

</html>