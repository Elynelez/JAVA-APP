<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Ruta de entrega</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Librería para QR -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body class="bg-light">

    <!-- HEADER -->
    <div th:insert="fragments/layout :: header"></div>

    <!-- FORMULARIO -->
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body p-5">
                    <h3 class="text-center mb-4 text-primary">
                        <i class="bi bi-truck"></i> Ruta de entrega
                    </h3>
                    <form id="deliveryForm" th:action="@{/delivery/route/save}" method="post" th:object="${route}">

                        <input type="hidden" th:field="*{deliveryCourier}" name="deliveryCourier" />

                        <!-- Escáner QR -->
                        <div class="mb-3">
                            <label class="form-label">Escanear Código QR</label>
                            <div id="reader" style="width:100%; max-width:350px; margin:auto;"></div>
                        </div>
                        <div class="mb-3">
                            <label for="registroTipo" class="form-label">Selecciona el tipo de registro</label>
                            <div class="input-group">
                                <select id="registroTipo" class="form-select">
                                    <option value="cliente">Registro de paquetes de cliente</option>
                                    <option value="centro">Registro de entrega centro logístico</option>
                                </select>
                            </div>
                        </div>

                        <!-- Pedidos Agregados -->
                        <div class="mb-3">
                            <label class="form-label">Pedidos Agregados</label>
                            <div style="max-height: 200px; overflow-y: auto;">
                                <ul id="ordersList" class="list-group">
                                    <!-- JS Insertará aquí los pedidos -->
                                </ul>
                            </div>
                        </div>

                        <div id="alertEmptyOrders" class="alert alert-danger d-none" role="alert">
                            Debes agregar al menos un pedido antes de enviar.
                        </div>

                        <!-- Botón enviar -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-send-check"></i> Enviar Pedidos
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div th:insert="fragments/layout :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById("deliveryForm").addEventListener("submit", function (e) {
            if (items.length === 0) {
                e.preventDefault(); // evita el envío
                const alertBox = document.getElementById("alertEmptyOrders");
                alertBox.classList.remove("d-none");
                alertBox.scrollIntoView({ behavior: "smooth" });
            }
        });

        function showAlert(message) {
            const alertBox = document.getElementById("alertEmptyOrders");
            alertBox.textContent = message;
            alertBox.classList.remove("d-none");
        }

        function hideAlert() {
            const alertBox = document.getElementById("alertEmptyOrders");
            alertBox.classList.add("d-none");
        }

        let items = JSON.parse(localStorage.getItem("items")) || [];
        const input = document.getElementById("itemInput");

        function updateSelect() {
            const ordersList = document.getElementById("ordersList");
            ordersList.innerHTML = '';

            items.forEach((item, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
                li.innerHTML = `
                    ${item}
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                `;
                ordersList.appendChild(li);
            });

            document.querySelectorAll("input[name='orders']").forEach(el => el.remove());
            const form = document.getElementById("deliveryForm");
            items.forEach(value => {
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "orders";
                hiddenInput.value = value;
                form.appendChild(hiddenInput);
            });
        }

        function addItem(code = null) {
            const value = code ? code.toUpperCase().trim() : input.value.toUpperCase().trim();
            if (!value) return showAlert("No puedes enviar contenido vacío");
            if (items.includes(value)) return showAlert("Pedido ya agregado");

            items.push(value);
            localStorage.setItem("items", JSON.stringify(items));
            updateSelect();
            hideAlert();
            if (!code) input.value = '';
        }

        function removeItem(index) {
            items.splice(index, 1);
            localStorage.setItem("items", JSON.stringify(items));
            updateSelect();
            if (items.length > 0) hideAlert();
        }

        // Inicializar QR Reader
        document.addEventListener("DOMContentLoaded", () => {
            updateSelect();

            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start(
                { facingMode: "environment" }, // cámara trasera
                config,
                (decodedText) => {
                    addItem(decodedText); // agregar pedido al escanear
                },
                (errorMessage) => {
                    // errores de lectura (ignorar)
                }
            ).catch(err => {
                console.error("Error al iniciar cámara:", err);
                alert("No se pudo acceder a la cámara.");
            });
        });
    </script>
</body>

</html>